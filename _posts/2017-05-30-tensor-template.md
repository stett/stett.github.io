---
title: Inline Tensor Convolution Using Template Expansion
layout: post
tags: [math, c++, templates, project]
comments: true
---

Last year I faced a problem which required me to compute products (convolutions) between vectors, matrixes, vectors of matrixes (rank-3 tensors).

I wanted to do this in C++ and the best option I could find seemed to be [FTensor](https://bitbucket.org/wlandry/ftensor). Although it probably would have worked for my particular case, FTensor seems to have been written in an older style which failed to make use of variadics, and I wanted something a bit more generic.

In a quest for further flexibility I began to work on my own tensor library, [Weyl](https://github.com/stett/weyl).

Weyl is header only and contains just one core class, `tensor`, whose entire source code is very short (at the moment, 367 lines including comments). Thanks to fancy-pants template expansion, large tensor convolutions are (usually!) compiled into a list of simple add and multiply operations.

I've also created specializations of the base tensor class, `vector` and `matrix`, and I plan to add some others like `quaternion` and possibly `affine`, but I may remove those in order to maintain the purity of the library. I'm always torn about that sort of thing &#x1F613;.

Here's the sort of thing I aim to do.

{% highlight c++ %}
weyl::tensor<float, 3, 3, 5> a({ ... });
weyl::tensor<float, 2, 5, 4> b({ ... });
weyl::tensor<float, 3, 3, 2, 4> c = weyl::sum<2, 1>(a, b);
{% endhighlight %}

This ought to be equivalent to the tensor convolution through a Riemann sum over one index.

$$
\begin{align*}
    C_{ijlm} = \sum_{k=1}^5 A_{ijk}B_{lkm}
\end{align*}
$$

In order to produce this result, we need the template function `sum` to expand to something equivalent to the following set of embedded loops (assuming that the values in the resulting tensor were initialized to zero).

{% highlight c++ %}
for (i = 0; i < 3; ++i) // i and j are a's contribution to c's rank indexes
for (j = 0; j < 3; ++j)
for (l = 0; l < 2; ++l) // l and m are b's contribution to c's rank indexes
for (m = 0; m < 4; ++m)
for (k = 0; k < 5; ++k) // k is the index of the dimension to sum over
    c[i][j][l][m] += a[i][j][k] * b[l][k][m];
{% endhighlight %}

This is essentially what `weyl::tensor` produces, and since the bounds of each loop are known, they are unrolled at compile time. You can see the sort of assembly it produces [here on Godbolt](https://godbolt.org/#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAKxAEZSBnVAV2OUxAHIBSAJgGY8AO2QAbZlgDU3fgGFhhPAENReAF6ZiAfVUMCM7NwAMAQT6CR4qTNkrgJQggC2B42dNClTzAwAOS9kkAd0wAT1E3bgB2ACE3SQTJAkwnX1ElZOk5AlDfTE9vSQAVUklhAkkAOSNS8oA6BqrXU0TJMSUGBiT8pmIZONN4xIKff0CsAiU8CJbE6IGTVtaAelXpAFZZPWJmZAqAETxvIQY8VCEhpclV5Y3ZACNiPEwAM0kAcTwAN3zJJUkGJgKqg3vhjqdzl1KlojEkEMQWMAEFUtE5Sr48MgANZwzCSACSBGR5zxSiE6EkCBYgLKBC6WF8RLKQkkXxUzEwdUuSxu3JWa3xLNQRM0wRI6AYpUO4LOFzk9EkAA5SrR%2BKVeLwDCAQGzxHiZPsDUq%2BYlkql0pkbOUCbUhBVqraCA06k1%2BIZZldtrsDkcerKTQl5gGlvlmE5pLFWez9fx9pJpX7zjZ8QBaBWVZ1anXRiOG/gLK6BqJ5hbBs1pDIx%2BR2qo1ZlOxqVZqLQtevbx30nf1yOsOqqZt3BoMewsJUPh%2BZRvVZOPVXP9IfFheDEf827cTZtioAJTJWODNzuj2eb0%2BPxZ/0BwNBnYhJxRsKJCOYSJRaMp1LxIskxD3pScXKrqaKQVpacjWn29SNs2o5bpIu5CPuQFFgWo6JOOEYxFOHIzpItDSLwWEQOUACUCH7nIGYNFmuo4dEJaLgxK4tlc5YWlWEEwa2BA7O25E2E2g7IZhwatBhk60TGcb4fRy4sUssn5pEwmHhuWw8d68GYOg3r%2BipaxqcerwfN8vyXkCkggpIYKJvelRws%2Br4ALKlMQKSoD8uIEkyJKlGSFJUswNL/MkJwkJZbzfm5DDMKIBDCMA1m3rKKiEKEgHya0bGVlk1YVPipTZckVp2gO2BtOknTFI6zquu6mWJHB27abpSbCcODWsSB7G5RBLn1rVTlcWhkhBQlP4tew6BaBURo5HkIxaTpezdrIqYKiU/YNKUlRDW62pFXibnLdpM02E5ZVyaOimlsJh25YdJUNlyboVR0XSbVBLqCfVsEaXxk3xUmPalJtVEvb9hYdSNCT3U9VT9V9kh7ZDI1jUIiXHbsp2zbGxQCc6pQXdRg5Ke1S5k%2B4nXXAZm7/Tuk14PcoiYEUPQkAetMPE8xkAAoIl8eBYF0/xBL%2Bvh5MQfzPuSXmhb03TmjlQQIJiyJOEooSSPceJBdpfwi5I/i/t4yRSy84XNctQMXHd3U5U9tU/cGTWM8zrPs305OoSNcPZLk%2BReHiRTDWh6OJfLJAzbhkd9HIYOXZT10U7d1N%2B7IoetK7y1MyzbNhXHGdCdT0Mw%2Bn82B4UIfFzDo2nBj3QF9HRrVz7Ckp8p1OqXTvEHCw7tW7sucewXnPrpsRlvPzHlCz4fwApgaCy7%2BiETdbsqlBbUsq78BBBKgzJYAAHnPThBRUOsTU4Hn6y8CLhiFntJAHGWjun1oAFKZ419Pxv3LOD2QMPfOvRFxtzfvbMCeUnbf09L/AAyswe4ok5ixBQVcNYlRhRfgQBkZkBFeAfzTHwXghUEB4hBC8K82stYkjaCQNyewuhby8i8AIFQiR4JCNLPEegHAY3QTyW435hDHwil5QES8KRYxWucfB35jZBzNkbAIOIVZqzKF0GR%2Bt7haxFII/kkgXh4GIHoSyQhOTFAQEFWkwRpiiG1hQixEUXiv1rsBJWUCK6LWrqjdx4dG69GbnjbxQclqtTlLISQH9JApjwqUQBwCn5Znuto6a%2BhKJlQOpAr8nszrx1cEnGGN1GJyTHncOCICSCyHOF8VA4gbblMMjzN4ABVQE9J/5HT3GvCJSQD4TE0E4YQOCjo%2BFipMGsFdxGPwLvQoQdSGl6TTjk3qNZyKOhtPWaJhUA4%2BJqtBGu3Fe7FE9jUhZ9TmCNO9oIgJsdglxlCYUQBjS5BbP2F0xJ7sqmF3gj0vgWEYkpNWYg%2B4WRsDZM8WMk66SCYkwhSAe69yMmyF8VdKGHdmKjm7upE5iCXD6XHtzE8kh2m5KhZITAR9/BdjkUQI2mgt7hljvMxZVzZRuK6hS%2BGAB5K5mgCrbL5WbD%2BmzBWf02eRSokq9woxdggsMYDBHlz2WE5qMU4qbSeXiXmShiAEBMLshaYTdX6piEayuwcDnfWtcjWBSw9AZExKyVAQsVH6uUKICA6qJkh14AANgmhqggpQl5mNNQavggbjYEC0EoUNkIKgRriAG91sb7gJpOBwz2NgE7wqjX8TNZjY65qJpdVNGbtnCAscQEiIlhKjhYcRGseBcJGH6GUXK1kgRTFENqBMtLInCoFTtLJ2Y9QdoBQCvAJEDGFnxTYSQw7iD4gBQqZdoqtmbqlQk2V4LtQxs9RAaKEyNwxDwBufY6I9WxqUGei96wr1pq0JW%2BN2tbQ1tnUUkaslyZMSphA7l4EawbrFZszd1od3bPInK4ScEF1vMFaBrdu7ELSr%2BYhJy4KlUNo8aBKs2qtLBq1aqwoEbDXP2NWRm95rKOWuqgNRstrYPUyzpMeKyAXVusPSob14zNUFpPXFItSab1mFTTGuNInJDJoLZJytYbs2j3jqO/Nqa32KcCRzFTyNy2Bsrdaatmg62l3cZIBDUTV2EXXfy4gm7BXbr3OhmD%2B6QA8a9UJkNz673rHPUIGtl7r36pfX5UoBn/PGfRT%2Bpcf6yl2yA3lJdtmIM1nFTWFLO4nMysw/a%2BDiq3lQeQw51DWJnN7vtaZtCKqqN4h9Zqi1i1yMNZNTR5rVdbXoaRix2ujqONcYpO5vjxHBP8a85p8jcmb1SfmeGmjk3gsKcTVpwueaIYFo00tktOniZrYrZsoztb62scLE260VA20dvO4uiYvb%2B3JWBrIZDO2aLRknYRAFVBZ24ZGhZjDpXSgbrXaUYrf2yuYdc4NzzZ6qCBe80F9N0PYdvvC5%2BqLaFf0l0xQBws79Uvgey/96DsrcsKpcAVrLOyUOg5K1hiraDvuK3ww9UjtXRskZqzJsTbWdWtbo/sxjNqBd2qOSNXrzq6ncZvUeurBA/WBs89JibEmpsbazZzs18303Sa26i1Tu3A2q%2BLTm7ben31Voi4dyrtdftQa/tZ4HpRHNoZpxDqXvGFdw%2Bfcg3zB2kdhY/ZF796OYuY//WWVZ8M0sVAy9TonOWRcOtJ4uqDMGHeU5T%2BVhPrQrc44j/7DnMv2f0aa3zlrZrucMaRp10qjRuswzF5xiXA23desLyN4NiuxOa%2Bm%2BNubyuFva%2BN7rra%2BvC0zaU6Ak3an9P7YtyZ%2Bnx2rieYInEPGkn/gACovdo%2BToaWLQeMeH48EHPwAQ8QhHCJEBfWU8%2ByEI59GskEa/fVDu0KqJaRyVd8Eg1QyAQCd2xS5kng%2BAsm/CEDDB1ilislESpTnism/A/2pgCRXhxCNBu2mG1H4kol7ETlTkAKJWAPeFAPIUkHAKcEgPERskHS0UwF8GinyGSApF0S8kJGRBgKPnEQQM9k5SWFx3yntQCSoLvFwnQL7RAAHTvGTB2hwPzUpmDACQUHilSg0CljmhZwBAIHQG1EUM9XUE0B0DwD0EXUIx11WyzB0OUNFEKTwMLDuTyVxkeSHzBhkLWzkMJSPBaXjCBCGRGTlifmmXUWQGRH3limkVGyMXvlZUuRtjsSZDJGFHISlljh4JvwS2tCj0py6wEPrkSiXjZRtgeVL0KFEO1B%2BXOXyNWm7UmAwJACwNkD7HBhez1DT03WcL1zLUaGBSbgyRsK6gLggHnziBD3D36M0zl2wkwEGMET0C0JAGMVEC9XQAyDfSWMmBX1rEKicL1wMAgEkhIi/XAVQT32xz6Mn2H0aMHFTVQElgyA5l80vWbQqBnSO1rjcgIFYBZFWJ83PUvR3yOIAMLE01MO2MuMDWuM0FuL6HuMfUeLKDrU0xzyXyBA%2BOsmWPvV%2BKD2z2GJHDoOwT2G0n/ztmU3OLKlRMmDPWqAxLbhKWYm5Gq3owf3tFf0qi6GBLqm5C/x/0xEJJOKEQIM8KII4RILIIoOgPJFgK6HgJIOSIJBZCJEMLaA6DxG1EkjsQWL%2BFECCE1i6EvloBSMSGQP%2BTxhKNqL3AEmsIBIwSAIFOILxBFNFCsiENlBoLoJ8AYJ0T0RINYMPipU4OlO4M5llLhAVKwGAHyAhPik8mQCVNKDAE4HxDjIBEClEApBUC1NCB1LxBUNQH1Nhlv3SOyPGidLkTQJ7RqIkNWkFWdjcKQJyOZEUEsNULxhmO0KEAbNUBUIMKMIKVJl6KWDsO6Jji2PZJrPwI8JJX2G8OIGGWcS4LmQCNViCLFFCKDQmQiNQHDDyOiNlFiORHiJFCSIDPiyZ0j3xyFzryuACS3KWXOEKMIxNLKNqW3IeyqNu1NMQnNP2nHQ5BaNBh2g6JdC6KCR6MtN4M9gGJEmxJWQS21VqhMGIGAAYHtVjggHgsQtqj1UQrrRADJLvUjEwoYFqnokguOJGN6AgCBPsILQSOMxePr00O1DQF8FCAgBouIDqC%2BNKDYo4uWPWPQy%2BIONKSxULHGPBN/CIChLiBhMMymIZzeJRK%2BPRMfT%2BKLFIuEjGOopuIkrPQeJkvHzopGnkuIE%2BLRJ9ypKEt5Jv0HLEshI3wos2yoquIPPhKW0RLAsHM8wgA33lIYAONXLikkA3yNDYo7SMpZCh0xP%2BOEtOKjn0CuK0o5ne1jHsrV2RWoucoMrQlOxbQu3zE7UXUEiwinUImeMUrMsfRX2CoPJ4vJPKpLAmneOMsCp8pUvnGiqNgRGSHxK0ODCKFwopPMs/yx25BxWAOnhOj8LmUCLYNZJIOvPZTkXgP3mW0IrpPzLx22U3Xvw62Y1DhMOHIuIRXunmoKJRRB2ewTxiicBSqN2JLMNBLH0oruoAtcArVksssSDWEnLNhnNGX8vigbhZQrlDTchyjJGZEdREAoTeEIFIEDP8nrKUI7NJHVOgLpAmNZIPhIWzJIVzLrnGmRRjnULZMOshSZxOtlHyTWkdxet7LItiv%2BogAby0GjO7NRR2KMH2Liy7luA%2BQkTDA1hiLiR8skFEFQGuPoWIGil8HOAlH6S8m3GeA1n8wBDDHwXBvFGED1T0SflxOtjxuyqeIt1yqwgOy7RNIrIeyrLHUkjexTT81RwZxNN%2BzrDrBBxNLqNJu/MwFKA9rNLkAuoRVVKzEh1G1CzN2RwD1rW5sAK0karlLmqfJvNtmpjCv%2BrR0PygovzEJ1xeDFoyHVFKDVDwgMCSFoDkmzuyWJLztQALskAABZC7JB%2BBS6CBNRKZK7EUh8a667i6FRG7m7W7%2BBcJO6rqbA6xy63QIACAFQ27BLmJlggrTBO7c786vNi7i767W6t6O6wgc7u616m71hSgd7yoCB1gK696q6zie716i6m7T6khA0jRR78tZBSES6p6CAB7z756TAN9lg3BOASJSA%2B1OB1hOBSAhAuAjBIHUAuAM53tCIAQWA2B9QBBaBIGCAYHgGQGsQQB1gjA6haAABOIwfgXgIwRUANdYfgf1Wgf1UBrgeuyB6BzgWB0geBzgSBhgEAGobB9h4B0gOAWAJANAVIaYTQcgSgcRjEFmYgEAYAf1UheYs2XhiAe4HB0gcR44AgHlIQUQUILR/ARhSMnwLR8oTAMB2BkB64m2XhzgFMGYg0ZAYqmIWgeu2JHlfgHh1B9gOgEBsBiBqBrRrho%2BRUf1FMf1Tx4AZATjf1OoXgSQCAXAQgcKcwBUGpCR%2BRgifgWgEiLBnB/Y0gfB%2BukhuoRUIwEh/1KIEh2gKIfgeu/1fgRURusBlhkJwRzhrgHhvh0gARmxwJrgXgVh0Jnp/popkBn4UxWUEAeuoAA). For brevity, the full source is not included in this example.
